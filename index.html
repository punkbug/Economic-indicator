<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://hits.sh https://ecos-dashboard-hyeonil.svg; connect-src 'self' https://api.allorigins.win https://ecos.bok.or.kr;">
  <title>í•œêµ­ ì£¼ìš” ê²½ì œì§€í‘œ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-S4YSTYvUvCstR9H2Uv6Yp6oVvInOQAnTknp4W9E0FbeR7S/WJkU9S0W5B7/D1S2b" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js" integrity="sha384-7u88N8Z6+5vK6Yv7v6Yv6Yv6Yv6Yv6Yv6Yv6Yv6Yv6Yv6Yv6Yv6Yv6Yv6Yv" crossorigin="anonymous"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0d1117; --bg2: #161b22; --card: #1c2128;
      --border: #30363d; --text: #e6edf3; --sub: #8b949e;
      --blue: #58a6ff; --green: #3fb950; --red: #f85149;
      --yellow: #d29922; --purple: #bc8cff;
    }
    [data-theme='light'] {
      --bg: #f6f8fa; --bg2: #ffffff; --card: #ffffff;
      --border: #d0d7de; --text: #1f2328; --sub: #656d76;
      --blue: #0969da; --green: #1a7f37; --red: #d1242f;
      --yellow: #9a6700; --purple: #8250df;
    }
    body { font-family: 'Segoe UI', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; transition: background 0.3s, color 0.3s; }
    header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 18px 40px; display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap; transition: background 0.3s, border-color 0.3s; }
    header h1 { font-size: 19px; font-weight: 700; cursor: pointer; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .hinfo { font-size: 12px; color: var(--sub); text-align: right; }
    .badge { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; padding: 3px 9px; border-radius: 20px; white-space: nowrap; }
    .badge.ok { background:#1a2d1a; color:var(--green); border:1px solid #2a4a2a; }
    [data-theme='light'] .badge.ok { background:#dafbe1; border-color:#bbe5c5; }
    .badge.loading { background:#1a2233; color:var(--blue); border:1px solid #2a3a5a; }
    [data-theme='light'] .badge.loading { background:#ddf4ff; border-color:#c2e7ff; }
    .badge.error { background:#2d1515; color:var(--red); border:1px solid #5a2a2a; }
    [data-theme='light'] .badge.error { background:#ffebe9; border-color:#ffcfcc; }
    .dot { width:6px; height:6px; border-radius:50%; }
    .badge.loading .dot { border:2px solid var(--blue); border-top-color:transparent; background:transparent; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .btn { padding:7px 14px; border-radius:6px; border:1px solid var(--border); background:var(--card); color:var(--text); font-size:12px; cursor:pointer; transition: all 0.2s; }
    .btn:hover { border-color: var(--sub); }
    .container { max-width:1200px; margin:0 auto; padding:28px 20px; }
    .init-loader { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:80px 20px; gap:16px; }
    .spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--blue); border-radius:50%; animation:spin .8s linear infinite; }
    .err-box { background:#2d1515; border:1px solid var(--red); border-radius:10px; padding:20px; color:var(--red); font-size:13px; line-height:1.6; }
    [data-theme='light'] .err-box { background:#ffebe9; }
    .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
    .kpi-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; cursor:pointer; transition:all .2s; border-top:3px solid var(--accent, var(--blue)); }
    .kpi-card.active { background:#1a2230; border-color:var(--accent); }
    [data-theme='light'] .kpi-card.active { background:#f0f7ff; }
    .kpi-label { font-size:11px; color:var(--sub); margin-bottom:10px; }
    .kpi-value { font-size:27px; font-weight:700; }
    .kpi-change { font-size:12px; margin-top:9px; }
    .up { color:var(--green); } .down { color:var(--red); }
    .chart-box { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:24px; margin-bottom:22px; }
    .chart-wrap { position:relative; height:300px; }
    #mainC { cursor: grab; }
    #mainC:active { cursor: grabbing; }
    .mini-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
    .mini-box { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px; }
    .mini-wrap { height:80px; }
    .modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:999; align-items:center; justify-content:center; }
    .modal-bg.show { display:flex; }
    .modal { background:var(--bg2); border:1px solid var(--border); border-radius:14px; padding:28px; width:400px; }
    .modal input { width:100%; padding:10px; margin:15px 0; background:var(--bg); border:1px solid var(--border); color:var(--text); }
    input:focus, textarea:focus { border-color: var(--blue) !important; outline: none; }
    @media (max-width:900px) { .kpi-grid { grid-template-columns:repeat(2,1fr); } }
    #counter { position: fixed; bottom: 15px; right: 15px; z-index: 1000; display: none; cursor: pointer; }
    #counter:hover { transform: scale(1.05); }
  </style>
</head>
<body data-theme="dark">

<div id="counter" title="í´ë¦­ ì‹œ ë°ì´í„° ê°±ì‹ " onclick="location.reload()">
  <img src="https://hits.sh/ecos-dashboard-hyeonil.svg?label=ë°©ë¬¸ì&color=58a6ff&labelColor=30363d" alt="Views"/>
</div>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>ğŸ”‘ API í‚¤ ì„¤ì •</h3>
    <input type="password" id="keyInput" placeholder="ECOS API ì¸ì¦í‚¤ ì…ë ¥" autocomplete="off" />
    <div style="text-align:right">
      <button class="btn" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn" style="background:var(--blue); color:#fff; border:none;" onclick="saveKey()">ì €ì¥</button>
    </div>
  </div>
</div>

<header>
  <div>
    <h1>ğŸ‡°ğŸ‡· ê²½ì œì§€í‘œ ëŒ€ì‹œë³´ë“œ</h1>
    <p style="font-size:12px; color:var(--sub)">í•œêµ­ì€í–‰ ECOS ì‹¤ì‹œê°„ ë°ì´í„°</p>
  </div>
  <div class="header-right">
    <div class="hinfo">
      <strong id="todayEl"></strong>
      <div id="badge" class="badge loading"><span class="dot"></span><span id="badgeTxt">ì¤€ë¹„ ì¤‘</span></div>
    </div>
    <button class="btn" id="themeBtn" onclick="toggleTheme()">ğŸŒ“ í…Œë§ˆ ì „í™˜</button>
    <button class="btn" onclick="location.href='#contact'">ğŸ¤ ì œíœ´ ë¬¸ì˜</button>
    <button class="btn" onclick="openModal()">ğŸ”‘ í‚¤ ì„¤ì •</button>
    <button class="btn" onclick="loadData()">ğŸ”„ ê°±ì‹ </button>
  </div>
</header>

<div class="container" id="app">
  <div class="init-loader">
    <div class="spinner"></div>
    <div class="load-txt">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>

<section id="contact" style="max-width:1200px; margin:40px auto; padding:0 20px;">
  <div style="background:var(--card); border:1px solid var(--border); border-radius:12px; padding:32px; border-top:3px solid var(--purple);">
    <h3 style="margin-bottom:8px; display:flex; align-items:center; gap:8px;">
      <span style="font-size:24px;">ğŸ¤</span> ì œíœ´ ë° ì„œë¹„ìŠ¤ ë¬¸ì˜
    </h3>
    <p style="font-size:13px; color:var(--sub); margin-bottom:24px;">ëŒ€ì‹œë³´ë“œ í™œìš© ì œíœ´ë‚˜ ê¸°íƒ€ ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì•„ë˜ í¼ì„ í†µí•´ ì—°ë½ì£¼ì„¸ìš”.</p>
    
    <form action="https://formspree.io/f/mreayogl" method="POST" style="display:flex; flex-direction:column; gap:16px;">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px;">
        <div style="display:flex; flex-direction:column; gap:8px;">
          <label style="font-size:12px; font-weight:600; color:var(--sub);">ì„±í•¨ ë˜ëŠ” ê¸°ì—…ëª…</label>
          <input type="text" name="name" required placeholder="ì˜ˆ: í™ê¸¸ë™ (ì£¼ì‹íšŒì‚¬ ì—ì½”)" 
            style="padding:10px; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:6px; outline:none; transition:border-color 0.2s;">
        </div>
        <div style="display:flex; flex-direction:column; gap:8px;">
          <label style="font-size:12px; font-weight:600; color:var(--sub);">íšŒì‹ ë°›ì„ ì´ë©”ì¼</label>
          <input type="email" name="_replyto" required placeholder="example@domain.com" 
            style="padding:10px; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:6px; outline:none; transition:border-color 0.2s;">
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <label style="font-size:12px; font-weight:600; color:var(--sub);">ë¬¸ì˜ ë‚´ìš©</label>
        <textarea name="message" required placeholder="ì œíœ´ ì œì•ˆì´ë‚˜ ê¶ê¸ˆí•œ ì ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”." 
          style="padding:12px; background:var(--bg); border:1px solid var(--border); color:var(--text); border-radius:6px; min-height:120px; resize:vertical; outline:none; transition:border-color 0.2s; font-family:inherit;"></textarea>
      </div>
      <div style="display:flex; justify-content: flex-end; align-items:center; gap:16px; margin-top:8px;">
        <span style="font-size:11px; color:var(--sub);">Formspreeë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ì „ë‹¬ë©ë‹ˆë‹¤.</span>
        <button type="submit" class="btn" style="background:var(--blue); color:white; border:none; padding:10px 24px; font-weight:600; font-size:14px;">ë³´ë‚´ê¸°</button>
      </div>
    </form>
  </div>
</section>

<script>
// Use a session variable instead of hardcoded key for better security
let API_KEY = localStorage.getItem('ecosApiKey') || '';
const BASE = 'https://ecos.bok.or.kr/api/StatisticSearch';

// Helper to escape HTML and prevent XSS
function escapeHTML(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
}

// Theme Management
function setTheme(theme) {
  document.body.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
  const subColor = getComputedStyle(document.documentElement).getPropertyValue('--sub').trim();
  const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
  Chart.defaults.color = subColor;
  Chart.defaults.borderColor = borderColor;
  if (DS.length > 0) {
    renderDashboard();
  }
}

function toggleTheme() {
  const current = document.body.getAttribute('data-theme');
  setTheme(current === 'dark' ? 'light' : 'dark');
}

// Initialize theme
const savedTheme = localStorage.getItem('theme') || 'dark';
setTheme(savedTheme);

function dateRange(days) {
  const now = new Date();
  const start = new Date();
  start.setDate(now.getDate() - days);
  const f = d => `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
  const fMonth = d => `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
  return { 
    s: f(start), e: f(now), 
    ms: fMonth(new Date(now.getFullYear(), now.getMonth() - 36)), me: fMonth(now) 
  };
}

async function fetchECOS(statCode, period, startDate, endDate, itemCode) {
  if (!API_KEY) throw new Error('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ”‘ í‚¤ ì„¤ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
  
  const rowCount = 1000;
  const targetUrl = `${BASE}/${API_KEY}/json/kr/1/${rowCount}/${statCode}/${period}/${startDate}/${endDate}/${itemCode}`;
  const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

  try {
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error(`ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ: ${res.status})`);
    const data = await res.json();
    const json = JSON.parse(data.contents);
    
    if (json.RESULT && json.RESULT.CODE !== 'INFO-000') {
      throw new Error(json.RESULT.MESSAGE || 'API ì‘ë‹µ ì˜¤ë¥˜');
    }
    if (!json.StatisticSearch || !json.StatisticSearch.row) return [];
    return json.StatisticSearch.row.sort((a, b) => a.TIME.localeCompare(b.TIME));
  } catch (e) {
    console.error('Fetch Error:', e);
    throw e;
  }
}

let DS = [];
let mainChart = null;

function renderDashboard() {
  const container = document.getElementById('app');
  container.innerHTML = ''; // Clear previous

  const kpiGrid = document.createElement('div');
  kpiGrid.className = 'kpi-grid';

  DS.forEach((d, i) => {
    if (!d.data.length) return;
    const lastVal = d.data.at(-1);
    const prevVal = d.data.at(-2) || lastVal;
    const valStr = parseFloat(lastVal).toLocaleString();
    const diff = parseFloat(lastVal) - parseFloat(prevVal);
    const cls = diff > 0 ? 'up' : 'down';
    const lastDate = d.rawDates.at(-1);
    const displayDate = lastDate.length === 8 
      ? `${lastDate.slice(4,6)}.${lastDate.slice(6,8)}` 
      : `${lastDate.slice(2,4)}.${lastDate.slice(4,6)}`;

    const card = document.createElement('div');
    card.className = `kpi-card ${i===0?'active':''}`;
    card.style.setProperty('--accent', d.color);
    card.onclick = () => syncUI(i);
    card.innerHTML = `
      <div class="kpi-label" style="display:flex; justify-content:space-between">
        <span>${escapeHTML(d.icon)} ${escapeHTML(d.name)}</span>
        <span style="opacity:0.6">${escapeHTML(displayDate)}</span>
      </div>
      <div class="kpi-value">${escapeHTML(valStr)}<span style="font-size:12px; color:var(--sub)">${escapeHTML(d.unit)}</span></div>
      <div class="kpi-change ${cls}">${diff > 0 ? 'â–²':'â–¼'} ${Math.abs(diff).toFixed(2)}</div>
    `;
    kpiGrid.appendChild(card);
  });

  const chartBox = document.createElement('div');
  chartBox.className = 'chart-box';
  chartBox.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
      <h3 id="mTitle"></h3>
      <button class="btn" style="font-size:11px" id="resetZoomBtn">ğŸ” ì´ˆê¸°í™”</button>
    </div>
    <div class="chart-wrap"><canvas id="mainC" style="touch-action: none"></canvas></div>
  `;

  const miniGrid = document.createElement('div');
  miniGrid.className = 'mini-grid';
  DS.forEach((d, i) => {
    const miniBox = document.createElement('div');
    miniBox.className = 'mini-box';
    miniBox.innerHTML = `<div>${escapeHTML(d.name)}</div><div class="mini-wrap"><canvas id="m${i}"></canvas></div>`;
    miniGrid.appendChild(miniBox);
  });

  container.appendChild(kpiGrid);
  container.appendChild(chartBox);
  container.appendChild(miniGrid);

  document.getElementById('resetZoomBtn').onclick = () => mainChart.resetZoom();

  syncUI(0);
  DS.forEach((_,i) => buildMiniChart(i));
}

function syncUI(i) {
  const mTitle = document.getElementById('mTitle');
  if (mTitle) mTitle.textContent = DS[i].title;
  document.querySelectorAll('.kpi-card').forEach((el, idx) => el.classList.toggle('active', idx === i));
  buildMainChart(i);
}

function buildMainChart(i) {
  const d = DS[i];
  const ctx = document.getElementById('mainC').getContext('2d');
  if (mainChart) mainChart.destroy();
  mainChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: d.labels,
      datasets: [{ data: d.data, borderColor: d.color, tension: 0.4, fill: false, pointRadius: 0, borderWidth: 2 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        zoom: {
          pan: { enabled: true, mode: 'x', threshold: 0 },
          zoom: { wheel: { enabled: true, speed: 0.1 }, pinch: { enabled: true }, mode: 'x' },
          limits: { x: { min: 'original', max: 'original' } }
        }
      },
      scales: {
        x: { ticks: { maxTicksLimit: 12, autoSkip: true } },
        y: { beginAtZero: false }
      }
    }
  });
}

function buildMiniChart(i) {
  const d = DS[i];
  const canvas = document.getElementById(`m${i}`);
  if (!canvas) return;
  new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: d.labels, datasets: [{ data: d.data, borderColor: d.color, pointRadius: 0, tension: 0.4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
  });
}

async function loadData() {
  if (!API_KEY) {
    document.getElementById('app').innerHTML = `<div class="init-loader"><button class="btn" style="padding:15px 30px; font-size:16px;" onclick="openModal()">ğŸ”‘ API í‚¤ ì„¤ì •í•˜ê¸°</button></div>`;
    return;
  }

  const badge = document.getElementById('badge');
  badge.className = 'badge loading';
  document.getElementById('badgeTxt').textContent = 'ê°±ì‹  ì¤‘...';

  const R = dateRange(1095);
  try {
    const [kospi, fx, rate, cpi] = await Promise.all([
      fetchECOS('802Y001', 'D', R.s, R.e, '0001000'),
      fetchECOS('731Y001', 'D', R.s, R.e, '0000001'),
      fetchECOS('722Y001', 'D', R.s, R.e, '0101000'),
      fetchECOS('901Y009', 'M', R.ms, R.me, '0')
    ]);

    const f = r => r.map(v => parseFloat(v.DATA_VALUE));
    const l = r => r.map(v => v.TIME.length === 8 ? `${v.TIME.slice(4,6)}.${v.TIME.slice(6,8)}` : `${v.TIME.slice(2,4)}.${v.TIME.slice(4,6)}`);
    const d = r => r.map(v => v.TIME);

    DS = [
      { name:'KOSPI', icon:'ğŸ“ˆ', title:'ì½”ìŠ¤í”¼ ì§€ìˆ˜', color:'#58a6ff', unit:'pt', data:f(kospi), labels:l(kospi), rawDates:d(kospi) },
      { name:'í™˜ìœ¨', icon:'ğŸ’±', title:'ì›/ë‹¬ëŸ¬ í™˜ìœ¨', color:'#3fb950', unit:'ì›', data:f(fx), labels:l(fx), rawDates:d(fx) },
      { name:'ê¸°ì¤€ê¸ˆë¦¬', icon:'ğŸ¦', title:'í•œêµ­ì€í–‰ ê¸°ì¤€ê¸ˆë¦¬', color:'#d29922', unit:'%', data:f(rate), labels:l(rate), rawDates:d(rate) },
      { name:'CPI', icon:'ğŸ“Š', title:'ì†Œë¹„ìë¬¼ê°€ì§€ìˆ˜', color:'#bc8cff', unit:'pt', data:f(cpi), labels:l(cpi), rawDates:d(cpi) }
    ];

    renderDashboard();
    badge.className = 'badge ok';
    document.getElementById('badgeTxt').textContent = 'ì •ìƒ';
  } catch (e) {
    badge.className = 'badge error';
    document.getElementById('badgeTxt').textContent = 'ì˜¤ë¥˜';
    document.getElementById('app').innerHTML = `
      <div class="err-box">
        âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>
        ì›ì¸: ${escapeHTML(e.message)}<br><br>
        1. API í‚¤ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.<br>
        2. CORS í”„ë¡ì‹œ ì„œë²„ ì§€ì—°ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 'ê°±ì‹ ' ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ë³´ì„¸ìš”.
      </div>`;
  }
}

function openModal() { document.getElementById('modalBg').classList.add('show'); }
function closeModal() { document.getElementById('modalBg').classList.remove('show'); }
function saveKey() {
  const v = document.getElementById('keyInput').value.trim();
  if(v) { API_KEY = v; localStorage.setItem('ecosApiKey', v); }
  closeModal();
  loadData();
}

document.getElementById('todayEl').textContent = new Date().toLocaleDateString();

// Secret way to toggle counter: Click "ê²½ì œì§€í‘œ ëŒ€ì‹œë³´ë“œ" 7 times
let cClicks = 0;
let cTimer;
const titleEl = document.querySelector('header h1');
if (titleEl) {
  titleEl.onclick = () => {
    clearTimeout(cTimer);
    cClicks++;
    if (cClicks === 7) {
      const show = localStorage.getItem('showCounter') === 'true';
      localStorage.setItem('showCounter', !show);
      const cEl = document.getElementById('counter');
      if (cEl) {
        cEl.style.display = !show ? 'block' : 'none';
        alert(`ê´€ë¦¬ì ëª¨ë“œ: ì¹´ìš´í„°ê°€ ${!show ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      cClicks = 0;
    } else {
      cTimer = setTimeout(() => { cClicks = 0; }, 2000);
    }
  };
}
if (localStorage.getItem('showCounter') === 'true') {
  document.getElementById('counter').style.display = 'block';
}

loadData();
</script>
</body>
</html>
