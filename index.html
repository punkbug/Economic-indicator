<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í•œêµ­ ì£¼ìš” ê²½ì œì§€í‘œ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #0d1117; --bg2: #161b22; --card: #1c2128;
      --border: #30363d; --text: #e6edf3; --sub: #8b949e;
      --blue: #58a6ff; --green: #3fb950; --red: #f85149;
      --yellow: #d29922; --purple: #bc8cff;
    }
    body { font-family: 'Segoe UI', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 18px 40px; display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap; }
    header h1 { font-size: 19px; font-weight: 700; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .hinfo { font-size: 12px; color: var(--sub); text-align: right; }
    .badge { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; padding: 3px 9px; border-radius: 20px; white-space: nowrap; }
    .badge.ok { background:#1a2d1a; color:var(--green); border:1px solid #2a4a2a; }
    .badge.loading { background:#1a2233; color:var(--blue); border:1px solid #2a3a5a; }
    .badge.error { background:#2d1515; color:var(--red); border:1px solid #5a2a2a; }
    .dot { width:6px; height:6px; border-radius:50%; }
    .badge.loading .dot { border:2px solid var(--blue); border-top-color:transparent; background:transparent; animation: spin .8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .btn { padding:7px 14px; border-radius:6px; border:1px solid var(--border); background:var(--card); color:var(--text); font-size:12px; cursor:pointer; }
    .container { max-width:1200px; margin:0 auto; padding:28px 20px; }
    .init-loader { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:80px 20px; gap:16px; }
    .spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--blue); border-radius:50%; animation:spin .8s linear infinite; }
    .err-box { background:#2d1515; border:1px solid var(--red); border-radius:10px; padding:20px; color:var(--red); font-size:13px; line-height:1.6; }
    .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; }
    .kpi-card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; cursor:pointer; transition:all .2s; border-top:3px solid var(--accent, var(--blue)); }
    .kpi-card.active { background:#1a2230; border-color:var(--accent); }
    .kpi-label { font-size:11px; color:var(--sub); margin-bottom:10px; }
    .kpi-value { font-size:27px; font-weight:700; }
    .kpi-change { font-size:12px; margin-top:9px; }
    .up { color:var(--green); } .down { color:var(--red); }
    .chart-box { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:24px; margin-bottom:22px; }
    .chart-wrap { position:relative; height:300px; }
    #mainC { cursor: grab; }
    #mainC:active { cursor: grabbing; }
    .mini-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
    .mini-box { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px; }
    .mini-wrap { height:80px; }
    .modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:999; align-items:center; justify-content:center; }
    .modal-bg.show { display:flex; }
    .modal { background:var(--bg2); border:1px solid var(--border); border-radius:14px; padding:28px; width:400px; }
    .modal input { width:100%; padding:10px; margin:15px 0; background:var(--bg); border:1px solid var(--border); color:#fff; }
    @media (max-width:900px) { .kpi-grid { grid-template-columns:repeat(2,1fr); } }
    #counter { position: fixed; bottom: 15px; right: 15px; z-index: 1000; display: none; cursor: pointer; }
    #counter:hover { transform: scale(1.05); }
  </style>
</head>
<body>

<div id="counter" title="í´ë¦­ ì‹œ ë°ì´í„° ê°±ì‹ " onclick="location.reload()">
  <img src="https://hits.sh/ecos-dashboard-hyeonil.svg?label=ë°©ë¬¸ì&color=58a6ff&labelColor=30363d" alt="Views"/>
</div>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>ğŸ”‘ API í‚¤ ì„¤ì •</h3>
    <input type="text" id="keyInput" placeholder="ECOS API ì¸ì¦í‚¤ ì…ë ¥" />
    <div style="text-align:right">
      <button class="btn" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn" style="background:var(--blue)" onclick="saveKey()">ì €ì¥</button>
    </div>
  </div>
</div>

<header>
  <div>
    <h1>ğŸ‡°ğŸ‡· ê²½ì œì§€í‘œ ëŒ€ì‹œë³´ë“œ</h1>
    <p style="font-size:12px; color:var(--sub)">í•œêµ­ì€í–‰ ECOS ì‹¤ì‹œê°„ ë°ì´í„°</p>
  </div>
  <div class="header-right">
    <div class="hinfo">
      <strong id="todayEl"></strong>
      <div id="badge" class="badge loading"><span class="dot"></span><span id="badgeTxt">ì¤€ë¹„ ì¤‘</span></div>
    </div>
    <button class="btn" onclick="openModal()">ğŸ”‘ í‚¤ ì„¤ì •</button>
    <button class="btn" onclick="loadData()">ğŸ”„ ê°±ì‹ </button>
  </div>
</header>

<div class="container" id="app">
  <div class="init-loader">
    <div class="spinner"></div>
    <div class="load-txt">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>

<script>
let API_KEY = localStorage.getItem('ecosApiKey') || '0AGD2DT4OUR0LS03IZ4K';
const BASE = 'https://ecos.bok.or.kr/api/StatisticSearch';

function dateRange(days) {
  const now = new Date();
  const start = new Date();
  start.setDate(now.getDate() - days);
  const f = d => `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
  const fMonth = d => `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
  return { 
    s: f(start), e: f(now), 
    ms: fMonth(new Date(now.getFullYear(), now.getMonth() - 36)), me: fMonth(now) 
  };
}

async function fetchECOS(statCode, period, startDate, endDate, itemCode) {
  const isSample = (API_KEY === 'sample' || API_KEY.length < 10);
  const rowCount = isSample ? 50 : 1000;
  const targetUrl = `${BASE}/${API_KEY}/json/kr/1/${rowCount}/${statCode}/${period}/${startDate}/${endDate}/${itemCode}`;
  const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}`;

  try {
    const res = await fetch(proxyUrl);
    if (!res.ok) throw new Error(`ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨ (ìƒíƒœ: ${res.status})`);
    const json = await res.json();
    if (json.RESULT) throw new Error(json.RESULT.MESSAGE || 'API ì‘ë‹µ ì˜¤ë¥˜');
    if (!json.StatisticSearch || !json.StatisticSearch.row) return [];
    return json.StatisticSearch.row.sort((a, b) => a.TIME.localeCompare(b.TIME));
  } catch (e) {
    console.error('Fetch Error:', e);
    throw e;
  }
}

let DS = [];
let mainChart = null;

function renderDashboard() {
  const kpiHtml = DS.map((d, i) => {
    if (!d.data.length) return '';
    const lastVal = d.data.at(-1);
    const prevVal = d.data.at(-2) || lastVal;
    const valStr = parseFloat(lastVal).toLocaleString();
    const diff = parseFloat(lastVal) - parseFloat(prevVal);
    const cls = diff > 0 ? 'up' : 'down';
    const lastDate = d.rawDates.at(-1);
    const displayDate = lastDate.length === 8 
      ? `${lastDate.slice(4,6)}.${lastDate.slice(6,8)}` 
      : `${lastDate.slice(2,4)}.${lastDate.slice(4,6)}`;

    return `
      <div class="kpi-card ${i===0?'active':''}" style="--accent:${d.color}" onclick="syncUI(${i})">
        <div class="kpi-label" style="display:flex; justify-content:space-between">
          <span>${d.icon} ${d.name}</span>
          <span style="opacity:0.6">${displayDate}</span>
        </div>
        <div class="kpi-value">${valStr}<span style="font-size:12px; color:var(--sub)">${d.unit}</span></div>
        <div class="kpi-change ${cls}">${diff > 0 ? 'â–²':'â–¼'} ${Math.abs(diff).toFixed(2)}</div>
      </div>`;
  }).join('');

  document.getElementById('app').innerHTML = `
    <div class="kpi-grid">${kpiHtml}</div>
    <div class="chart-box">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
        <h3 id="mTitle"></h3>
        <button class="btn" style="font-size:11px" onclick="mainChart.resetZoom()">ğŸ” ì´ˆê¸°í™”</button>
      </div>
      <div class="chart-wrap"><canvas id="mainC" style="touch-action: none"></canvas></div>
  </div>
  <div class="mini-grid">${DS.map((d,i)=>`<div class="mini-box"><div>${d.name}</div><div class="mini-wrap"><canvas id="m${i}"></canvas></div></div>`).join('')}</div>
`;
syncUI(0);
DS.forEach((_,i) => buildMiniChart(i));
}

function syncUI(i) {
document.getElementById('mTitle').textContent = DS[i].title;
document.querySelectorAll('.kpi-card').forEach((el, idx) => el.classList.toggle('active', idx === i));
buildMainChart(i);
}

function buildMainChart(i) {
const d = DS[i];
const ctx = document.getElementById('mainC').getContext('2d');
if (mainChart) mainChart.destroy();
mainChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: d.labels,
    datasets: [{ data: d.data, borderColor: d.color, tension: 0.4, fill: false, pointRadius: 0, borderWidth: 2 }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { display: false },
      zoom: {
        pan: {
          enabled: true,
          mode: 'x',
          threshold: 0, // ì¦‰ì‹œ ë°˜ì‘í•˜ë„ë¡ ì„¤ì •
        },
        zoom: {
          wheel: { enabled: true, speed: 0.1 },
          pinch: { enabled: true },
          mode: 'x',
        },
        limits: {
          x: { min: 'original', max: 'original' }
        }
      }
    },
    scales: {
      x: { ticks: { maxTicksLimit: 12, autoSkip: true } },
      y: { beginAtZero: false }
    }
  }
});
}

function buildMiniChart(i) {
  const d = DS[i];
  new Chart(document.getElementById(`m${i}`).getContext('2d'), {
    type: 'line',
    data: { labels: d.labels, datasets: [{ data: d.data, borderColor: d.color, pointRadius: 0, tension: 0.4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
  });
}

async function loadData() {
  const badge = document.getElementById('badge');
  badge.className = 'badge loading';
  document.getElementById('badgeTxt').textContent = 'ê°±ì‹  ì¤‘...';

  const R = dateRange(1095); // ìµœê·¼ 3ë…„ ë°ì´í„°
  try {
    const [kospi, fx, rate, cpi] = await Promise.all([
      fetchECOS('802Y001', 'D', R.s, R.e, '0001000'),
      fetchECOS('731Y001', 'D', R.s, R.e, '0000001'),
      fetchECOS('722Y001', 'D', R.s, R.e, '0101000'),
      fetchECOS('901Y009', 'M', R.ms, R.me, '0')
    ]);

    const f = r => r.map(v => parseFloat(v.DATA_VALUE));
    const l = r => r.map(v => v.TIME.length === 8 ? `${v.TIME.slice(4,6)}.${v.TIME.slice(6,8)}` : `${v.TIME.slice(2,4)}.${v.TIME.slice(4,6)}`);
    const d = r => r.map(v => v.TIME);

    DS = [
      { name:'KOSPI', icon:'ğŸ“ˆ', title:'ì½”ìŠ¤í”¼ ì§€ìˆ˜', color:'#58a6ff', unit:'pt', data:f(kospi), labels:l(kospi), rawDates:d(kospi) },
      { name:'í™˜ìœ¨', icon:'ğŸ’±', title:'ì›/ë‹¬ëŸ¬ í™˜ìœ¨', color:'#3fb950', unit:'ì›', data:f(fx), labels:l(fx), rawDates:d(fx) },
      { name:'ê¸°ì¤€ê¸ˆë¦¬', icon:'ğŸ¦', title:'í•œêµ­ì€í–‰ ê¸°ì¤€ê¸ˆë¦¬', color:'#d29922', unit:'%', data:f(rate), labels:l(rate), rawDates:d(rate) },
      { name:'CPI', icon:'ğŸ“Š', title:'ì†Œë¹„ìë¬¼ê°€ì§€ìˆ˜', color:'#bc8cff', unit:'pt', data:f(cpi), labels:l(cpi), rawDates:d(cpi) }
    ];

    renderDashboard();
    badge.className = 'badge ok';
    document.getElementById('badgeTxt').textContent = 'ì •ìƒ';
  } catch (e) {
    badge.className = 'badge error';
    document.getElementById('badgeTxt').textContent = 'ì˜¤ë¥˜';
    document.getElementById('app').innerHTML = `<div class="err-box">âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ì›ì¸: ${e.message}<br><br>CORS í”„ë¡ì‹œ ì„œë²„ ì§€ì—°ì´ê±°ë‚˜ API í‚¤ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 'ê°•ë ¥ ìƒˆë¡œê³ ì¹¨(Ctrl+F5)'ì„ ì‹œë„í•´ë³´ì„¸ìš”.</div>`;
  }
}

function openModal() { document.getElementById('modalBg').classList.add('show'); }
function closeModal() { document.getElementById('modalBg').classList.remove('show'); }
function saveKey() {
  const v = document.getElementById('keyInput').value.trim();
  if(v) { API_KEY = v; localStorage.setItem('ecosApiKey', v); }
  closeModal();
  loadData();
}

document.getElementById('todayEl').textContent = new Date().toLocaleDateString();
Chart.defaults.color = '#8b949e';

// Secret way to toggle counter: Click "ê²½ì œì§€í‘œ ëŒ€ì‹œë³´ë“œ" 7 times
let cClicks = 0;
let cTimer;
const titleEl = document.querySelector('header h1');
if (titleEl) {
  titleEl.onclick = () => {
    clearTimeout(cTimer);
    cClicks++;
    if (cClicks === 7) {
      const show = localStorage.getItem('showCounter') === 'true';
      localStorage.setItem('showCounter', !show);
      const cEl = document.getElementById('counter');
      if (cEl) {
        cEl.style.display = !show ? 'block' : 'none';
        alert(`ê´€ë¦¬ì ëª¨ë“œ: ì¹´ìš´í„°ê°€ ${!show ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      }
      cClicks = 0;
    } else {
      cTimer = setTimeout(() => { cClicks = 0; }, 2000);
    }
  };
}
if (localStorage.getItem('showCounter') === 'true') {
  document.getElementById('counter').style.display = 'block';
}

loadData();
</script>
</body>
</html>
